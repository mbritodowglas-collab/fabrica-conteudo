// assets/js/static.js
// Download em PNG para o "Post estático" (estilo Twitter)

(function () {
  console.log('[static] script static.js carregado.');

  // Botão de download (por id ou por data-attr)
  const btn =
    document.getElementById('download-static') ||
    document.querySelector('[data-download="static"]');

  if (!btn) {
    console.warn('[static] Botão #download-static / [data-download="static"] não encontrado no DOM.');
    return;
  }

  // Wrapper principal que contém o card estático
  const wrapper =
    document.querySelector('.fc-static-wrapper') ||
    document.querySelector('[data-static-wrapper]') ||
    document.querySelector('.fc-static');

  if (!wrapper) {
    console.warn('[static] Wrapper estático (.fc-static-wrapper / [data-static-wrapper] / .fc-static) não encontrado. Nada para capturar.');
    return;
  }

  console.log('[static] wrapper encontrado:', wrapper);
  console.log('[static] botão encontrado:', btn);

  btn.addEventListener('click', async () => {
    console.log('[static] clique no botão detectado.');
    // Pequeno alerta só pra confirmar que o evento está disparando
    // (pode remover depois que estiver tudo ok)
    alert('Gerando imagem do post estático…');

    try {
      if (typeof html2canvas !== 'function') {
        console.error('[static] html2canvas não está disponível. Confere se o script foi incluído ANTES de static.js.');
        alert('Erro: html2canvas não carregou. Confere os scripts no layout.');
        return;
      }

      // Garante que o bloco está visível e centralizado na tela
      wrapper.scrollIntoView({ behavior: 'auto', block: 'center' });

      console.log('[static] iniciando captura com html2canvas...');

      const canvas = await html2canvas(wrapper, {
        scale: 2,      // mais nítido
        useCORS: true  // ajuda com imagens/avatars externos
        // backgroundColor: null // se quiser fundo transparente
      });

      console.log('[static] captura concluída:', canvas);

      // Gera um slug básico para nome do arquivo
      let slug = document.body.getAttribute('data-slug');
      if (!slug) {
        const rawTitle = document.title || 'post-estatico';
        slug = rawTitle
          .replace(/· Estático · Fábrica de Conteúdo/i, '')
          .trim()
          .toLowerCase()
          .replace(/[^\w]+/g, '-');
      }

      const filename = `${slug || 'post-estatico'}.png`;

      // Usa toBlob + URL.createObjectURL (mais confiável em vários browsers)
      if (!canvas.toBlob) {
        console.warn('[static] canvas.toBlob não disponível, usando fallback dataURL.');

        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log('[static] download iniciado (fallback dataURL):', filename);
        alert('Download da imagem foi disparado (fallback). Verifica na pasta de downloads.');
        return;
      }

      canvas.toBlob((blob) => {
        if (!blob) {
          console.error('[static] não consegui gerar o blob da imagem.');
          alert('Erro: não consegui gerar o arquivo de imagem. Tenta recarregar a página e testar de novo.');
          return;
        }

        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        URL.revokeObjectURL(url);

        console.log('[static] download iniciado com blob:', filename);
        alert('Download da imagem foi disparado. Verifica na pasta de downloads.');
      }, 'image/png');
    } catch (error) {
      console.error('[static] erro ao gerar ou baixar imagem:', error);
      alert('Rolou um erro ao gerar a imagem. Abre o console do navegador para ver o detalhe do erro.');
    }
  });
})();